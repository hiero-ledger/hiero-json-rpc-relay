name: Hoppscotch Endpoint Tests

on:
    pull_request:
        branches: [main, release/**]
    push:
        branches: [main, release/**]
        tags: [v*]
    workflow_dispatch:

concurrency:
    group: pr-checks-${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    setup-local-hedera:
        name: Hoppscotch Endpoint Tests
        runs-on: hiero-smart-contracts-linux-medium
        permissions:
            contents: write
            actions: read
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Install build tools
              run: sudo apt-get update && sudo apt-get install -y make gcc g++

            - name: Setup node
              uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
              with:
                  node-version: 22

            - name: Checkout repo
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

            - name: Install packages
              run: npm ci

            - name: Create .env file
              run: cp ./packages/server/tests/localAcceptance.env .env

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Build Typescript
              run: npx lerna run build

            - name: Start the hedera local node
              run: npx hedera start -d

            - name: Stop the local node's relay
              run: docker stop json-rpc-relay

            - name: Start the local relay
              run: npm run start &

            - name: Install Hoppscotch CLI
              run: npm install -g @hoppscotch/cli

            - name: Run Hoppscotch Tests
              run: BASE_URL=http://127.0.0.1:7546 hopp test packages/server/tests/hoppscotch.json
