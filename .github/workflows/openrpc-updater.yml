
name: OpenRPC JSON Updater

on:
  push:
    branches:
      - main
    paths:
      - 'docs/openrpc.json'
  pull_request:
    branches:
      - branches: [main, release/**]
    paths:
      - 'docs/openrpc.json'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  clone-and-build-execution-apis:
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout execution-apis repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
          repository: 'ethereum/execution-apis'
          path: 'execution-apis'

      - name: Use Node.js TLS 22
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install
        working-directory: ./execution-apis

      - name: Build project
        run: npm run build
        working-directory: ./execution-apis

      - name: Upload openrpc.json as an artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: openrpc
          path: ./execution-apis/refs-openrpc.json

  update-openrpc:
    runs-on: ubuntu-latest
    needs: clone-and-build-execution-apis
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: 'main'
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Download openrpc.json artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          name: openrpc
          path: ./downloaded-artifacts/

      - name: Copy generated openrpc.json to scripts directory
        run: |
          mkdir -p scripts/openrpc-json-updater
          cp ./downloaded-artifacts/refs-openrpc.json scripts/openrpc-json-updater/original-openrpc.json

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22

      - name: Install dependencies
        working-directory: scripts/openrpc-json-updater
        run: npm install

      - name: Generate comparison report
        id: generate-report
        working-directory: scripts/openrpc-json-updater
        run: |
          REPORT_OUTPUT=$(node cli.js --original ./original-openrpc.json --modified ../../docs/openrpc.json)
          echo "REPORT_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$REPORT_OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # This workflow automatically creates PRs when the OpenRPC JSON file differs from the upstream source.
      # PRs are only created when actual changes are detected (SKIP_PR=false), ensuring that
      # maintainers can review and approve schema updates before they're merged into the main branch.
      # This provides a safety mechanism for tracking OpenRPC specification changes over time.
      - name: Perform merge
        id: merge
        working-directory: scripts/openrpc-json-updater
        run: |
          MERGE_OUTPUT=$(node cli.js --merge --original ./original-openrpc.json --modified ../../docs/openrpc.json)
          MERGE_EXIT_CODE=$?
          echo "$MERGE_OUTPUT"

          if [ $MERGE_EXIT_CODE -eq 0 ]; then
            if [[ "$MERGE_OUTPUT" =~ No\ differences\ found\ after\ merge ]]; then
              echo "No differences found. Skipping PR creation."
              echo "SKIP_PR=true" >> $GITHUB_ENV
              exit 0
            elif [[ "$MERGE_OUTPUT" == *"Merge completed"* ]]; then
              echo "Successfully updated openrpc.json"
              echo "SKIP_PR=false" >> $GITHUB_ENV
            else
              echo "Unexpected output. Output was: $MERGE_OUTPUT"
              exit 1
            fi
          else
            echo "Failed to update file. Output was: $MERGE_OUTPUT"
            exit 1
          fi

      - name: Generate unique branch name
        id: branch-name
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          UNIQUE_BRANCH="update-openrpc-${TIMESTAMP}"
          echo "UNIQUE_BRANCH=${UNIQUE_BRANCH}" >> $GITHUB_ENV
          echo "Generated unique branch name: ${UNIQUE_BRANCH}"

      - name: Create Pull Request
        if: env.SKIP_PR != 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          commit-message: Update OpenRPC JSON
          title: 'Update OpenRPC JSON'
          body: |
            # OpenRPC JSON Update

            This PR updates the OpenRPC JSON specification with the latest changes from Ethereum JSON-RPC specification.

            ## Comparison Report
            ```
            ${{ env.REPORT_OUTPUT }}
            ```
          branch: ${{ env.UNIQUE_BRANCH }}
          base: 'main'
          add-paths: docs/openrpc.json
          delete-branch: true
